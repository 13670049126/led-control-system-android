name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y git zip unzip openjdk-11-jdk python3-pip autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev cmake libffi-dev libssl-dev
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython==0.29.32
    
    - name: Build APK
      run: |
        # 直接修改buildozer.spec文件，添加必要配置
        echo "android.no_use_distutils = True" >> buildozer.spec
        
        # 使用直接修改方法，避免Kivy补丁检查
        # 先克隆python-for-android并修改Kivy recipe
        git clone https://github.com/kivy/python-for-android.git
        
        # 直接替换整个Kivy recipe文件
        cat > python-for-android/pythonforandroid/recipes/kivy/__init__.py << 'EOF'
from pythonforandroid.recipe import PythonRecipe


class KivyRecipe(PythonRecipe):
    version = '1.11.1'
    url = 'https://github.com/kivy/kivy/archive/{version}.zip'
    depends = ['python3', 'sdl2', 'pyjnius', 'android']
    call_hostpython_via_targetpython = False

    def get_recipe_env(self, arch=None):
        env = super().get_recipe_env(arch)
        env['USE_SDL2'] = '1'
        return env

    def is_kivy_affected_by_deadlock_issue(recipe, arch):
        # Always return False to skip patch check
        return False

    def apply_patches(self, arch):
        # Skip all patches by returning early
        return

recipe = KivyRecipe()
EOF
        
        # 设置buildozer使用我们修改后的python-for-android
        echo "p4a.source_dir = $(pwd)/python-for-android" >> buildozer.spec
        
        # 运行构建，设置环境变量允许root用户运行
        BUILDOZER_ALLOW_ROOT=1 buildozer android debug --log-level=2
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: ledcontrol-apk
        path: bin/*.apk
