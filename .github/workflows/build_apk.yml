name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y git zip unzip openjdk-11-jdk python3-pip autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev cmake libffi-dev libssl-dev
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython
    
    - name: Build APK
      run: |
        # 创建一个自定义构建脚本，包含jnius修补步骤
        cat > build_with_patch.sh << 'EOF'
        #!/bin/bash
        set -x
        
        # 安装sed工具（如果需要）
        sudo apt-get update && sudo apt-get install -y sed grep findutils
        
        # 显示当前目录和环境
        pwd
        ls -la
        
        # 第一次运行buildozer，让它下载所有依赖
        echo "=== First buildozer run (dependency download) ==="
        buildozer android debug --verbose || true
        
        # 查找jnius源码文件并显示
        echo "=== Finding jnius source files ==="
        find /home/runner/.buildozer -name "*.pxi" -o -name "*.pyx" > all_files.txt
        grep -l "long" /home/runner/.buildozer/**/*.pxi 2>/dev/null || echo "No .pxi files found with 'long'"
        grep -l "long" /home/runner/.buildozer/**/*.pyx 2>/dev/null || echo "No .pyx files found with 'long'"
        
        # 修补jnius源码中的long类型问题
        echo "=== Patching jnius source files ==="
        # 直接指定jnius_utils.pxi文件的路径模式
        find /home/runner/.buildozer -path "*/jnius/*" -name "*.pxi" -o -name "*.pyx" | xargs grep -l "long" > files_to_patch.txt
        cat files_to_patch.txt || echo "No files to patch"
        
        # 执行替换
        if [ -s files_to_patch.txt ]; then
            while read -r file; do
                echo "Patching $file"
                sed -i 's/isinstance(arg, long)/isinstance(arg, int)/g' "$file"
                sed -i 's/(isinstance(arg, long)/(isinstance(arg, int)/g' "$file"
                sed -i 's/long(/int(/g' "$file"
            done < files_to_patch.txt
        fi
        
        # 第二次运行buildozer，进行实际构建
        echo "=== Second buildozer run (actual build) ==="
        buildozer android debug --verbose
        EOF
        
        chmod +x build_with_patch.sh
        ./build_with_patch.sh
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: ledcontrol-apk
        path: bin/*.apk
