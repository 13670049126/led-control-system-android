name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y git zip unzip openjdk-11-jdk python3-pip autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev cmake libffi-dev libssl-dev
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython
    
    - name: Build APK
      run: |
        # 两步构建策略：1. 先下载依赖 2. 修复所有jnius文件 3. 完成构建
        
        # 第一步：运行buildozer让它下载所有依赖，即使失败
        buildozer android debug --verbose || true
        
        # 第二步：查找并修复所有jnius相关文件中的long类型
        echo "=== Finding and fixing all jnius files ==="
        
        # 查找所有jnius相关的.pxi和.pyx文件
        JNIUS_FILES=$(find /home/runner -path "*/jnius/*" -name "*.pxi" -o -name "*.pyx" 2>/dev/null)
        
        if [ -n "$JNIUS_FILES" ]; then
            echo "Found jnius files:"
            echo "$JNIUS_FILES"
            
            # 修复每个文件
            for file in $JNIUS_FILES; do
                echo "=== Fixing $file ==="
                # 显示包含long的行
                grep -n "long" "$file" || echo "No 'long' found in $file"
                
                # 替换所有long相关的代码
                sed -i 's/isinstance(arg, long)/isinstance(arg, int)/g' "$file"
                sed -i 's/isinstance(py_arg, long)/isinstance(py_arg, int)/g' "$file"
                sed -i 's/(int, long)/(int, int)/g' "$file"
                sed -i 's/(long, int)/(int, int)/g' "$file"
                sed -i 's/(long)/(int)/g' "$file"
                sed -i 's/long(/int(/g' "$file"
                
                # 显示修复后的相关行
                echo "=== After fixing ==="
                grep -n "int" "$file" | grep -i "instance" || echo "No 'instance' found after fix"
            done
        else
            echo "No jnius files found, skipping fix"
        fi
        
        # 第三步：再次运行buildozer完成构建
        echo "=== Running buildozer again to complete build ==="
        buildozer android debug --verbose
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: ledcontrol-apk
        path: bin/*.apk
